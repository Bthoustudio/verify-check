<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ°´å®…ç ”å±…ï½œé˜²å½ç“¶è™ŸæŸ¥é©—ç³»çµ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-xl mx-auto mt-16 p-6 bg-white shadow-md rounded-md border border-gray-200">
    <h2 class="text-2xl font-bold mb-4 flex items-center text-indigo-800">
      ğŸ” <span class="ml-2">æ°´å®…ç ”å±…ï½œé˜²å½ç“¶è™ŸæŸ¥é©—ç³»çµ±</span>
    </h2>

    <form id="query-form" class="flex items-center gap-2 mb-4">
      <input type="text" id="sn" placeholder="è«‹è¼¸å…¥é˜²å½ç“¶è™Ÿï¼Œä¾‹å¦‚ï¼šBTH600-A01-00001"
             class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-indigo-500" />
      <button type="submit"
              class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">æŸ¥è©¢</button>
    </form>

    <div id="result" class="text-gray-800"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("query-form");
      const input = document.getElementById("sn");
      const resultBox = document.getElementById("result");

      const bottleDataURL = "data/data.json"; // æŸ¥é©—è³‡æ–™ JSON
      const modelImageURL = "https://script.google.com/macros/s/AKfycbxbmV64Jql7clWQqCaeakyjqkwIfCoRteVROpKeVGRh0dzU8ERdgGdZ95GGNBz7Chmt/exec";

      let modelImageMap = {};

      // é å…ˆè¼‰å…¥å‹è™Ÿå°æ‡‰åœ–ç‰‡è³‡æ–™
      fetch(modelImageURL)
        .then(res => res.json())
        .then(data => {
          data.forEach(item => {
            if (item["å‹è™Ÿ"] && item["å°æ‡‰åœ–ç‰‡ç¶²å€"]) {
              modelImageMap[item["å‹è™Ÿ"].trim().toLowerCase()] = item["å°æ‡‰åœ–ç‰‡ç¶²å€"];
            }
          });
        })
        .catch(err => {
          console.error("åœ–ç‰‡å°æ‡‰è³‡æ–™è¼‰å…¥éŒ¯èª¤ï¼š", err);
        });

      // æŸ¥è©¢æäº¤
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const sn = input.value.trim();
        if (!sn) return;

        input.classList.remove("border-red-500");
        resultBox.innerHTML = "æŸ¥è©¢ä¸­...";

        try {
          const response = await fetch(bottleDataURL);
          const data = await response.json();

          const record = data.find(item => item["ç“¶è™Ÿ"] === sn);

          if (!record) {
            input.classList.add("border-red-500");
            resultBox.innerHTML = `
              <h2 class="text-red-600 font-semibold">âš ï¸ æŸ¥ç„¡æ­¤ç“¶è™Ÿè³‡æ–™</h2>
              <p>è«‹ç¢ºèªæ‚¨è¼¸å…¥çš„ç“¶è™Ÿæ˜¯å¦æ­£ç¢ºï¼Œæˆ–è¯ç¹«æ°´å®…å®¢æœã€‚</p>
            `;
            return;
          }

          const formatDate = (dateStr) => {
            try {
              return new Date(dateStr).toLocaleDateString("zh-TW", { year: "numeric", month: "numeric", day: "numeric" });
            } catch {
              return dateStr?.split("T")[0] || "-";
            }
          };

          const revoke = record["æ˜¯å¦å›æ”¶"] === "æ˜¯";
          const now = new Date();
          const received = record["é ˜å–æ™‚é–“"] ? new Date(record["é ˜å–æ™‚é–“"]) : null;
          const sixMonthsPassed = received && ((now - received) > (180 * 24 * 60 * 60 * 1000));

          const model = record["å‹è™Ÿ"]?.trim();
          const modelKey = model?.toLowerCase();
          const imageURL = modelImageMap[modelKey];

          const validStatus = revoke
            ? '<span class="text-red-600 font-semibold">å·²è¨»éŠ·</span>'
            : '<span class="text-green-600 font-semibold">æ˜¯</span>';

          const extraWarning = (!revoke && sixMonthsPassed)
            ? '<p class="text-yellow-600 font-semibold">âš ï¸ é ˜å–æ™‚é–“å·²è¶…éåŠå¹´ï¼Œè«‹å‘ç¸½éƒ¨ç”³è«‹æ›´æ›ã€‚</p>'
            : "";

          const imageHTML = imageURL
            ? `<img src="${decodeURIComponent(imageURL)}" alt="å‹è™Ÿ ${model} åœ–ç‰‡" class="mt-4 w-full max-w-xs mx-auto border rounded shadow" />`
            : `<div class="mt-4 text-sm text-gray-500 italic">ğŸ” æ‰¾ä¸åˆ°å‹è™Ÿå°æ‡‰åœ–ç‰‡</div>`;

          resultBox.innerHTML = `
            <div class="border-t pt-4 mt-4 space-y-1">
              <h3 class="text-lg font-semibold text-green-600">âœ… æŸ¥é©—æˆåŠŸï¼š${record["ç“¶è™Ÿ"]}</h3>
              <p>ä½¿ç”¨åº—å®¶ï¼š${record["ä½¿ç”¨åº—å®¶"]}</p>
              <p>å‹è™Ÿï¼š${model}</p>
              <p>é ˜å–æ™‚é–“ï¼š${formatDate(record["é ˜å–æ™‚é–“"])}</p>
              <p>æ˜¯å¦æœ‰æ•ˆï¼š${validStatus}</p>
              <p>è¨»éŠ·æ™‚é–“ï¼š${formatDate(record["å›æ”¶æ™‚é–“"])}</p>
              ${extraWarning}
              ${imageHTML}
            </div>
          `;
        } catch (error) {
          console.error("è³‡æ–™è¼‰å…¥éŒ¯èª¤ï¼š", error);
          resultBox.innerHTML = "<p class='text-red-600'>æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>";
        }
      });

      // æ”¯æ´ç¶²å€åƒæ•¸è‡ªå‹•æŸ¥è©¢
      const params = new URLSearchParams(window.location.search);
      const preset = params.get("sn");
      if (preset) {
        input.value = preset;
        form.dispatchEvent(new Event("submit"));
      }
    });
  </script>
</body>
</html>
